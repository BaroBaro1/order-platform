<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬</title>
  <style>
    body {
      background:#f4f4f9;
      font-family: Arial, sans-serif;
      padding: 20px;
    }

    .container {
      max-width: 900px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,.1);
    }

    h2 { text-align:center; margin-bottom:20px; }

    table {
      width:100%;
      border-collapse: collapse;
      margin-top:20px;
    }

    th, td {
      border:1px solid #ddd;
      padding:10px;
      text-align:center;
    }

    th {
      background:#007bff;
      color:white;
    }

    .status {
      padding:5px 10px;
      border-radius:5px;
      color:white;
    }

    .pending { background:#ffc107; color:black; }
    .done { background:#28a745; }

    .back {
      display:inline-block;
      margin-bottom:15px;
      text-decoration:none;
      background:#333;
      color:white;
      padding:8px 12px;
      border-radius:5px;
    }

    #empty {
      text-align:center;
      margin-top:20px;
      color:#777;
    }
    .canceled {
  background: #dc3545;
}

  </style>
</head>

<body>

<div class="container">

  <a class="back" href="dashboard.html">â¬… Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ§Ø¬Ø±</a>

  <h2>ğŸ“¦ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬</h2>

  <table>
    <thead>
  <tr>
    <th>ID Ø§Ù„Ø·Ù„Ø¨</th>
    <th>Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†</th>
    <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
    <th>Ø§Ù„ÙˆÙ„Ø§ÙŠØ©</th>
    <th>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
  </tr>
</thead>

    <tbody id="ordersBody"></tbody>
  </table>

  <p id="empty"></p>
</div>

<script>
const ordersBody = document.getElementById("ordersBody");
const emptyMsg = document.getElementById("empty");

// Ù‚Ø±Ø§Ø¡Ø© productId Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
const params = new URLSearchParams(window.location.search);
const productId = params.get('productId');

if (!productId) {
  emptyMsg.textContent = "Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ù†ØªØ¬!";
  throw new Error("Product ID missing in URL");
}

// Ø±Ù‚Ù… Ø§Ù„ØªØ§Ø¬Ø±
const merchantId = 1;

// Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„ØªØ§Ø¬Ø±
fetch(`http://localhost:3000/merchants/${merchantId}/orders`)
  .then(res => res.json())
  .then(data => {
    console.log("Orders from API:", data);

    // ÙÙ„ØªØ±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ù†ØªØ¬ ÙÙ‚Ø·
    const filteredOrders = data.filter(order => order.product.id == productId);

    if (filteredOrders.length === 0) {
      emptyMsg.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ø­Ø§Ù„ÙŠØ§Ù‹";
      return;
    }

    filteredOrders.forEach(order => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
  <td>${order.id}</td>
  <td>${order.customerName}</td>
  <td>${order.customerPhone}</td>
  <td>${order.wilaya}</td>
  <td>${order.totalPrice} Ø¯Ø¬</td>
  <td id="status-${order.id}" 
      class="status ${order.status === 'done' ? 'done' : 'pending'}">
    ${order.status === 'done' ? 'Ù…ÙƒØªÙ…Ù„' : 'Ù…Ø¹Ù„Ù‚'}
  </td>
  <td>
    <button onclick="updateStatus(${order.id}, 'done')">âœ… ØªØ£ÙƒÙŠØ¯</button>
    <button onclick="updateStatus(${order.id}, 'canceled')">âŒ Ø¥Ù„ØºØ§Ø¡</button>
  </td>
`;
      ordersBody.appendChild(tr);
    });
  })
  .catch(err => {
    console.error("Error:", err);
    emptyMsg.textContent = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª";
  });
  function updateStatus(orderId, newStatus) {
  fetch(`http://localhost:3000/orders/${orderId}`, {
    method: "PATCH",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ status: newStatus })
  })
  .then(res => res.json())
  .then(updatedOrder => {
    console.log("Updated:", updatedOrder);

    const statusCell = document.getElementById(`status-${orderId}`);

    if (newStatus === "done") {
      statusCell.textContent = "Ù…ÙƒØªÙ…Ù„";
      statusCell.className = "status done";
    } else {
      statusCell.textContent = "Ù…Ù„ØºÙ‰";
      statusCell.className = "status canceled";
    }
  })
  .catch(err => console.error("Update error:", err));
}

</script>

</body>
</html>
